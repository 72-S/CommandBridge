name: Upload to Modrinth

on:
  release:
    types: [created]

jobs:
  upload-to-modrinth:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Get Release Assets URLs
        id: get-release-assets
        run: |
          release_url="https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ github.event.release.tag_name }}"
          assets=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" $release_url | jq -r '.assets[] | select(.name | test("CommandBridgeBukkit|CommandBridgeVelocity")) | .browser_download_url')
          echo "$assets" > assets_urls.txt
          while read -r line; do
            if [[ $line == *"CommandBridgeBukkit"* ]]; then
              echo "BUKKIT_ASSET_URL=$line" >> $GITHUB_ENV
            elif [[ $line == *"CommandBridgeVelocity"* ]]; then
              echo "VELOCITY_ASSET_URL=$line" >> $GITHUB_ENV
            fi
          done < assets_urls.txt

      - name: Download Bukkit JAR Artifact
        run: |
          curl -L -o ./downloaded/bukkit/CommandBridgeBukkit.jar ${{ env.BUKKIT_ASSET_URL }}

      - name: Download Velocity JAR Artifact
        run: |
          curl -L -o ./downloaded/velocity/CommandBridgeVelocity.jar ${{ env.VELOCITY_ASSET_URL }}

      - name: List Downloaded Files
        run: |
          echo "Downloaded files in ./downloaded/bukkit:"
          ls -la ./downloaded/bukkit
          echo "Downloaded files in ./downloaded/velocity:"
          ls -la ./downloaded/velocity

      - name: Upload Bukkit JAR to Modrinth
        uses: cloudnode-pro/modrinth-publish@1.0.0
        with:
          token: ${{ secrets.MODRINTH_TOKEN }}
          project: wIuI4ru2
          changelog: ${{ github.event.release.body }}
          file: ./downloaded/bukkit/CommandBridgeBukkit.jar
          loaders: '["bukkit"]'
          dependencies: '[]'

      - name: Upload Velocity JAR to Modrinth
        uses: cloudnode-pro/modrinth-publish@1.0.0
        with:
          token: ${{ secrets.MODRINTH_TOKEN }}
          project: wIuI4ru2
          changelog: ${{ github.event.release.body }}
          file: ./downloaded/velocity/CommandBridgeVelocity.jar
          loaders: '["velocity"]'
          dependencies: '[]'
